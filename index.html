<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analytiq Dashboard</title>
  <script id="tracker" src="https://analytiq-omega.vercel.app/tracker.js" data-site="OwnerdemoSite"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    body { font-family:'Inter',sans-serif; background:#f9fafb; margin:0; color:#111827; }

    /* Header */
    header { background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; padding:20px 40px; text-align:center; }
    header h1 { margin:0; font-size:26px; font-weight:600; }

    .controls { margin:20px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .controls input, .controls button {
      padding:10px 14px; font-size:14px; border-radius:8px; border:1px solid #ddd;
    }
    .controls button { background:#6366f1; color:#fff; border:none; cursor:pointer; transition:background 0.2s; }
    .controls button:hover { background:#4f46e5; }

    .error { color:red; text-align:center; margin:10px 0; }

    /* Dashboard Layout */
    .dashboard { display:grid; grid-template-columns:2fr 1fr; gap:20px; margin:20px; }
    .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; }
    .card {
      background:#fff; padding:20px; border-radius:16px;
      box-shadow:0 6px 16px rgba(0,0,0,0.08); text-align:center;
    }
    .card h2 { font-size:18px; margin:0 0 8px; font-weight:600; }
    .card p { font-size:28px; margin:0; font-weight:600; color:#4f46e5; }

    canvas { background:#fff; padding:20px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.08); }

    .list { list-style:none; padding:0; margin:0; }
    .list li { padding:8px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; font-size:14px; }
    .list li:last-child{ border-bottom:none; }

    /* Buttons */
    .btn { padding:10px 20px; background:#ef4444; color:#fff; border:none; border-radius:8px; cursor:pointer; margin:20px auto; display:block; }
    .btn:hover { background:#dc2626; }

    /* Modal */
    .modal{ display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(2px);}
    .modal-content{
      background:#fff; margin:5% auto; padding:20px; border-radius:16px; width:90%; max-width:1000px;
      box-shadow:0 10px 25px rgba(0,0,0,0.2); animation:fadeIn 0.3s ease;
    }
    @keyframes fadeIn{from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);}}
    .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
    .modal-header h2{ margin:0; font-size:20px; font-weight:600;}
    .close{ cursor:pointer; font-size:24px; color:#555;}
    .close:hover{ color:#111;}

    table { width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,0.06);}
    th,td { padding:12px 16px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#f3f4f6; font-weight:600; }

    /* Welcome Modal */
    #welcomeModal .modal-content{ max-width:700px; padding:30px; }
    .modal-header-guide{ background:linear-gradient(90deg,#2563eb,#3b82f6); padding:15px; border-radius:12px; color:#fff; text-align:center;}
    code{ display:block; background:#f3f4f6; padding:8px 10px; border-radius:6px; margin:8px 0;}
    #copyBtn{ margin-top:10px; padding:6px 12px; background:#2563eb; border:none; border-radius:6px; color:#fff; cursor:pointer;}
    #copyBtn:hover{ background:#1d4ed8;}
  </style>
</head>
<body>
  <!-- Welcome Modal -->
  <div id="welcomeModal" class="modal">
   <span class="close" id="closeWelcome">&times;</span>
    <div class="modal-content">
      <div class="modal-header-guide"><h2>üöÄ Welcome to Analytiq Dashboard</h2></div>
      <p>Track your website traffic with ease! Just add this snippet to your site:</p>
      <code id="scriptCode">&lt;script id="tracker" src="https://analytiq-omega.vercel.app/tracker.js" data-site="YOUR_SITE_ID"&gt;&lt;/script&gt;</code>
      <button id="copyBtn">üìã Copy</button>
    </div>
  </div>

  <!-- Header -->
  <header><h1>üìä Analytiq Dashboard</h1></header>

  <!-- Controls -->
  <div class="controls">
    <input type="text" id="siteIdInput" placeholder="Enter Site ID" />
    <button id="loadBtn">Load Analytics</button>
    <button id="openModalBtn">View Events</button>
    <button onclick="openWelcome()">‚ùî Setup Guide</button>
  </div>
  <div id="errorMsg" class="error"></div>

  <!-- Dashboard -->
  <div class="dashboard">
    <div>
      <div class="stats">
        <div class="card"><h2>Visits</h2><p id="visits">0</p></div>
        <div class="card"><h2>Unique Visitors</h2><p id="uniqueVisitors">0</p></div>
        <div class="card"><h2>Pageviews</h2><p id="pageviews">0</p></div>
      </div>
      <canvas id="trafficChart" height="120" style="margin-top:20px;"></canvas>
    </div>
    <div>
      <div class="card"><h2>Top Pages</h2><ul id="topPages" class="list"></ul></div>
      <div class="card" style="margin-top:20px;"><h2>Top Referrers</h2><ul id="topReferrers" class="list"></ul></div>
      <div class="card" style="margin-top:20px;"><h2>Top Browsers</h2><ul id="topBrowsers" class="list"></ul></div>
    </div>
  </div>

  <button class="btn" onclick="clearAnalytics()">Clear Analytics</button>

  <!-- Events Modal -->
  <div id="eventsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Detailed Events</h2><span class="close" id="closeModal">&times;</span></div>
      <table>
        <thead><tr><th>URL</th><th>Referrer</th><th>User Agent</th><th>Time</th></tr></thead>
        <tbody id="analyticsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase + Chart.js -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const firebaseConfig = {
      apiKey:"AIzaSyCy3wdI31dGW869qdPg08-KDuVmEyICILE",
      authDomain:"web--analytics.firebaseapp.com",
      databaseURL:"https://web--analytics-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"web--analytics",
      storageBucket:"web--analytics.firebasestorage.app",
      messagingSenderId:"740756570650",
      appId:"1:740756570650:web:d352ca5bcb75a9bcf947a3"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    const siteIdInput=document.getElementById("siteIdInput");
    const errorDiv=document.getElementById("errorMsg");
    const tableBody=document.getElementById("analyticsTable");
    const visitsEl=document.getElementById("visits");
    const uniqueVisitorsEl=document.getElementById("uniqueVisitors");
    const pageviewsEl=document.getElementById("pageviews");
    const topPagesEl=document.getElementById("topPages");
    const topReferrersEl=document.getElementById("topReferrers");
    const topBrowsersEl=document.getElementById("topBrowsers");
    const openModalBtn=document.getElementById("openModalBtn");
    const eventsModal=document.getElementById("eventsModal");
    const closeModal=document.getElementById("closeModal");
    const welcomeModal=document.getElementById("welcomeModal");
    const closeWelcome=document.getElementById("closeWelcome");
    const copyBtn=document.getElementById("copyBtn");
    const scriptCode=document.getElementById("scriptCode");

    let chart,cachedData=null,currentRef=null;

    function showError(msg){ errorDiv.textContent=msg; console.error(msg); }
    function clearTable(){ tableBody.innerHTML=""; }
    function renderList(container,data){
      container.innerHTML=""; Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([k,v])=>{
        const li=document.createElement("li"); li.innerHTML=`<span>${k}</span><span>${v}</span>`; container.appendChild(li);
      });
    }
    function renderTable(data){
      clearTable(); Object.entries(data).forEach(([key,e])=>{
        const row=document.createElement("tr");
        row.innerHTML=`<td>${e.url||"-"}</td><td>${e.referrer||"-"}</td><td>${e.userAgent||"-"}</td><td>${new Date(e.timestamp).toLocaleString()}</td>`;
        tableBody.appendChild(row);
      });
    }

    function loadAnalytics(siteId){
      if(!siteId){ showError("Please enter a Site ID"); return;}
      errorDiv.textContent=""; if(currentRef) currentRef.off();
      currentRef=db.ref("analytics/"+siteId);
      currentRef.on("value",snap=>{
        const data=snap.val(); if(!data){ showError("No data for this site"); return;}
        cachedData=data;
        let visits=0,unique=new Set(),pageviews=0,daily={},pages={},refs={},browsers={};
        Object.values(data).forEach(e=>{
          visits++; pageviews++; unique.add(e.userAgent||"unknown");
          const d=new Date(e.timestamp).toLocaleDateString();
          daily[d]=(daily[d]||0)+1;
          pages[e.url||"unknown"]=(pages[e.url||"unknown"]||0)+1;
          refs[e.referrer||"direct"]=(refs[e.referrer||"direct"]||0)+1;
          const agent=e.userAgent||"unknown"; let b="Other";
          if(agent.includes("Chrome")) b="Chrome"; else if(agent.includes("Firefox")) b="Firefox";
          else if(agent.includes("Safari")&&!agent.includes("Chrome")) b="Safari"; else if(agent.includes("Edge")) b="Edge";
          browsers[b]=(browsers[b]||0)+1;
        });
        visitsEl.textContent=visits; uniqueVisitorsEl.textContent=unique.size; pageviewsEl.textContent=pageviews;
        renderList(topPagesEl,pages); renderList(topReferrersEl,refs); renderList(topBrowsersEl,browsers);
        const labels=Object.keys(daily),values=Object.values(daily);
        if(chart) chart.destroy(); const ctx=document.getElementById("trafficChart").getContext("2d");
        chart=new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"Visits",data:values,borderColor:"#6366f1",backgroundColor:"rgba(99,102,241,0.2)",fill:true,tension:0.3}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
      },err=>showError("Firebase error: "+err.message));
    }

    document.getElementById("loadBtn").onclick=()=>loadAnalytics(siteIdInput.value.trim());
    openModalBtn.onclick=()=>{ if(cachedData){renderTable(cachedData); eventsModal.style.display="block";} else showError("Load analytics first!");};
    closeModal.onclick=()=>eventsModal.style.display="none";
    window.onclick=e=>{ if(e.target===eventsModal) eventsModal.style.display="none"; if(e.target===welcomeModal) welcomeModal.style.display="none";};

    function clearAnalytics(){ if(currentRef) currentRef.remove(); }

    // Welcome modal + copy
    function openWelcome(){ welcomeModal.style.display="block"; }
    closeWelcome.onclick=()=>welcomeModal.style.display="none";
    copyBtn.onclick=()=>{ navigator.clipboard.writeText(scriptCode.textContent).then(()=>{copyBtn.textContent="‚úÖ Copied!"; setTimeout(()=>copyBtn.textContent="üìã Copy",1500);});};
    window.onload=()=>openWelcome();

    const params=new URLSearchParams(window.location.search);
    const siteFromUrl=params.get("site"); if(siteFromUrl){ siteIdInput.value=siteFromUrl; loadAnalytics(siteFromUrl);}
  </script>
</body>
</html>
