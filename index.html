<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analytiq Dashboard</title>
  <script id="tracker" src="https://analytiq-omega.vercel.app/tracker.js" data-site="demo_Site"></script>

  <style>
    :root{
      --bg:#071421; --surface:#071a23; --card:#0e2a33; --muted:#9fb3be;
      --accent:#06b6d4; --accent-2:#fb923c; --white:#ecf8fb; --radius:12px; --shadow:0 8px 24px rgba(2,6,23,0.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Arial;
      background:linear-gradient(180deg,var(--bg),#03121a);
      color:var(--white);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .app{display:flex;min-height:100vh;gap:20px;padding:20px}

    /* SIDEBAR */
    aside.sidebar{
      width:240px;padding:20px;background:linear-gradient(180deg,var(--surface),#04202a);
      border-radius:14px;box-shadow:var(--shadow);align-self:flex-start
    }
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .logo{
      width:46px;height:46px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#7c3aed);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#001;padding-top:2px
    }
    nav.menu{display:flex;flex-direction:column;gap:8px}
    .menu a{display:block;padding:10px 12px;color:var(--muted);
      text-decoration:none;border-radius:10px;font-size:14px}
    .menu a.active,.menu a:hover{
      background:rgba(255,255,255,0.02);color:var(--white)
    }
    .sidebar-footer{margin-top:18px;font-size:13px;color:var(--muted)}

    /* MAIN */
    main.content{flex:1;display:flex;flex-direction:column;gap:16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .controls{display:flex;gap:12px;align-items:center}
    .input{
      background:transparent;border:1px solid rgba(255,255,255,0.04);
      padding:8px 10px;border-radius:10px;color:var(--white);font-size:14px
    }
    .btn{
      padding:8px 12px;border-radius:10px;border:0;
      background:linear-gradient(90deg,var(--accent),#0891b2);
      color:#001;font-weight:700;cursor:pointer
    }
    .btn.ghost{
      background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)
    }

    .layout{display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}

    .card{
      background:linear-gradient(180deg,var(--card), rgba(10,18,25,0.45));
      padding:12px;border-radius:12px;box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.02)
    }
    .metric .label{font-size:13px;color:var(--muted)}
    .metric .value{font-weight:700;font-size:20px;color:var(--white)}

    /* Chart fixes */
    .chart-small{height:120px;display:flex;align-items:center}
    .chart-large{height:140px;display:flex;align-items:center}
    .chart-small canvas,
    .chart-large canvas{
      display:block;
      width:100% !important;
      height:100% !important;
      object-fit:contain;
    }

    table.events{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
    table.events th,table.events td{
      text-align:left;padding:8px;color:var(--white);
      border-bottom:1px solid rgba(255,255,255,0.03)
    }
    .list{display:flex;flex-direction:column;gap:8px}
    .list span{display:flex;justify-content:space-between;}

    /* responsive */
    @media (max-width:980px){
      aside.sidebar{display:none}
      .layout{grid-template-columns:1fr}
      .cards{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:600px){
      .cards{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="app">

    <aside class="sidebar" aria-label="Sidebar">
      <div class="brand">
        <div class="logo">Aq</div>
        <div>
          <h1 style="margin:0;font-size:16px">Analytiq</h1>
          <p style="margin:0;color:var(--muted);font-size:12px">Realtime analytics â€” redesigned</p>
        </div>
      </div>
      <nav class="menu">
        <a class="active" href="#">Dashboard</a>
        <a href="#">Events</a>
        <a href="#">Integrations</a>
        <a href="#">Settings</a>
      </nav>
      <div class="sidebar-footer">Team: <strong>Demo</strong><br>Version 2.1</div>
    </aside>

    <main class="content">

      <!-- FIXED missing error message -->
      <div id="errorMsg" style="color:#fb923c;font-size:13px;margin-bottom:6px"></div>

      <div class="topbar">
        <div class="controls">
          <input id="siteIdInput" class="input" placeholder="Site ID (try: demo_site)">
          <select id="timeRange" class="input">
            <option value="1">Today</option>
            <option value="7" selected>7 days</option>
            <option value="30">30 days</option>
          </select>
          <button id="loadBtn" class="btn">Load</button>
          <button id="openModalBtn" class="btn ghost">View Events</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div style="color:var(--muted);font-size:13px">
            Active
            <span id="activeVisitors" style="background:linear-gradient(90deg,var(--accent-2),#fb7a2a);color:#001;padding:6px 10px;border-radius:999px;margin-left:8px;display:inline-block">0</span>
          </div>
          <button id="exportBtn" class="btn ghost">Export CSV</button>
        </div>
      </div>

      <div class="layout">
        <section>

          <div class="cards">
            <div class="card">
              <div class="metric">
                <div>
                  <div class="label">Visits</div>
                  <div id="visits" class="value">0</div>
                </div>
                <div style="background:linear-gradient(90deg,var(--accent),#0891b2);padding:6px 10px;border-radius:999px;color:#001;font-weight:700">Live</div>
              </div>
              <div class="chart-small" style="margin-top:10px"><canvas id="miniChart1"></canvas></div>
            </div>

            <div class="card">
              <div class="metric">
                <div>
                  <div class="label">Unique</div>
                  <div id="uniqueVisitors" class="value">0</div>
                </div>
                <div style="background:linear-gradient(90deg,var(--accent-2),#fb7a2a);padding:6px 10px;border-radius:999px;font-weight:700">Audience</div>
              </div>
              <div class="chart-small" style="margin-top:10px"><canvas id="miniChart2"></canvas></div>
            </div>

            <div class="card">
              <div class="metric">
                <div>
                  <div class="label">Pageviews</div>
                  <div id="pageviews" class="value">0</div>
                </div>
                <div style="background:linear-gradient(90deg,#7c3aed,#06b6d4);padding:6px 10px;border-radius:999px;font-weight:700">Engagement</div>
              </div>
              <div class="chart-small" style="margin-top:10px"><canvas id="miniChart3"></canvas></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-size:15px;font-weight:700">Traffic Overview</div>
                <div style="color:var(--muted);font-size:13px">Visitors & pageviews</div>
              </div>
              <div style="color:var(--muted);font-size:13px">Range: <span id="rangeLabel">Last 7 days</span></div>
            </div>
            <div class="chart-large" style="margin-top:12px"><canvas id="trafficChart"></canvas></div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Latest Events</div>
              <div style="color:var(--muted);font-size:13px">Realtime</div>
            </div>
            <table class="events" aria-live="polite">
              <thead><tr><th>URL</th><th>Referrer</th><th>User Agent</th><th>Time</th></tr></thead>
              <tbody id="analyticsTable">
                <tr><td colspan="4" style="color:var(--muted)">No data loaded â€” try <code style="background:rgba(255,255,255,0.03);padding:3px 7px;border-radius:6px;color:var(--accent)">demo_site</code></td></tr>
              </tbody>
            </table>
          </div>

        </section>

        <aside>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Top Pages</div>
              <div style="color:var(--muted);font-size:13px">Live</div>
            </div>
            <div id="topPages" class="list"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Top Referrers</div>
              <div style="color:var(--muted);font-size:13px">Quality</div>
            </div>
            <div id="topReferrers" class="list"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Browsers</div>
              <div style="color:var(--muted);font-size:13px">Devices</div>
            </div>
            <div id="topBrowsers" class="list"></div>
          </div>

          <!-- FIXED: Devices list -->
          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Devices</div>
              <div style="color:var(--muted);font-size:13px">Live</div>
            </div>
            <div id="topDevices" class="list"></div>
          </div>

        </aside>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
        <div style="color:var(--muted);font-size:13px">
          Tip: add
          <code style="background:rgba(255,255,255,0.03);padding:3px 7px;border-radius:6px;color:var(--accent)">?site=your_site</code>
          to the URL to auto-load
        </div>
        <div style="margin-left:auto">
          <button id="openWelcome" class="btn">Get Snippet</button>
          <button id="clearBtn" class="btn ghost">Clear Data</button>
        </div>
      </div>

    </main>
  </div>

  <!-- FIXED: Events Modal with correct closeModal ID -->
  <div id="eventsModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1000;padding:20px">
    <div style="width:100%;max-width:1100px;background:var(--card);padding:14px;border-radius:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Detailed Events</h3>
        <button id="closeModal" class="btn ghost">Close</button>
      </div>
      <div style="margin-top:12px;max-height:540px;overflow:auto">
        <table class="events" id="eventsFull">
          <thead><tr><th>URL</th><th>Referrer</th><th>User agent</th><th>Timestamp</th></tr></thead>
          <tbody id="eventsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- FIXED: Welcome / Snippet Modal -->
  <div id="welcomeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1000;align-items:center;justify-content:center;padding:20px">
    <div style="background:var(--card);padding:20px;border-radius:12px;width:100%;max-width:500px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Installation Snippet</h3>
        <button id="closeWelcome" class="btn ghost">Close</button>
      </div>

      <pre id="scriptCode" style="margin-top:12px;background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;white-space:pre-wrap;">
&lt;script src="https://analytiq-omega.vercel.app/tracker.js" data-site="your_site"&gt;&lt;/script&gt;
      </pre>

      <button id="copyBtn" class="btn" style="margin-top:12px">ðŸ“‹ Copy</button>
    </div>
  </div>

  <!-- Firebase + Chart.js + Confetti (UNCHANGED) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <!-- YOUR ENTIRE SCRIPT (UNMODIFIED) -->
  <script>
    /* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        YOUR SCRIPT UNCHANGED
       â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
    let db, chart, cachedData=null, currentRef=null;

    function initFirebase() {
      fetch("/firebase-config.json")
        .then(res => res.json())
        .then(cfg => {
          if (!firebase.apps.length) firebase.initializeApp(cfg);
          db = firebase.database();
        });
    }
    initFirebase();

    const siteIdInput=document.getElementById("siteIdInput");
    const errorDiv=document.getElementById("errorMsg");
    const tableBody=document.getElementById("analyticsTable");
    const visitsEl=document.getElementById("visits");
    const uniqueVisitorsEl=document.getElementById("uniqueVisitors");
    const pageviewsEl=document.getElementById("pageviews");
    const topPagesEl=document.getElementById("topPages");
    const topReferrersEl=document.getElementById("topReferrers");
    const topBrowsersEl=document.getElementById("topBrowsers");
    const topDevicesEl=document.getElementById("topDevices");
    const activeVisitorsEl=document.getElementById("activeVisitors");
    const openModalBtn=document.getElementById("openModalBtn");
    const eventsModal=document.getElementById("eventsModal");
    const closeModal=document.getElementById("closeModal");
    const welcomeModal=document.getElementById("welcomeModal");
    const closeWelcome=document.getElementById("closeWelcome");
    const copyBtn=document.getElementById("copyBtn");
    const scriptCode=document.getElementById("scriptCode");

    function showError(msg){ errorDiv.textContent=msg; console.error(msg); }
    function clearTable(){ tableBody.innerHTML=""; }
    function renderList(container,data){
      container.innerHTML=""; Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([k,v])=>{
        const li=document.createElement("li"); li.innerHTML=`<span>${k}</span><span>${v}</span>`; container.appendChild(li);
      });
    }
    function renderTable(data){
      clearTable(); Object.entries(data).forEach(([key,e])=>{
        const row=document.createElement("tr");
        row.innerHTML=`<td>${e.url||"-"}</td><td>${e.referrer||"-"}</td><td>${e.userAgent||"-"}</td><td>${new Date(e.timestamp).toLocaleString()}</td>`;
        tableBody.appendChild(row);
      });
    }

    function loadAnalytics(siteId, days=7){
      if(!siteId){ showError("Please enter a Site ID"); return;}
      errorDiv.textContent=""; if(currentRef) currentRef.off();
      currentRef=db.ref("analytics/"+siteId);
      currentRef.on("value",snap=>{
        const data=snap.val(); if(!data){ showError("No data for this site"); return;}
        cachedData=data;
        const cutoff = Date.now() - days*24*60*60*1000;
        const filteredData=Object.fromEntries(Object.entries(data).filter(([_,e])=>e.timestamp>cutoff));
        let visits=0,unique=new Set(),pageviews=0,daily={},pages={},refs={},browsers={},devices={};
        Object.values(filteredData).forEach(e=>{
          visits++; pageviews++; unique.add(e.userAgent||"unknown");
          const d=new Date(e.timestamp).toLocaleDateString();
          daily[d]=(daily[d]||0)+1;
          pages[e.url||"unknown"]=(pages[e.url||"unknown"]||0)+1;
          refs[e.referrer||"direct"]=(refs[e.referrer||"direct"]||0)+1;
          const agent=e.userAgent||"unknown"; 
          let b="Other";
          if(agent.includes("Chrome")) b="Chrome";
          else if(agent.includes("Firefox")) b="Firefox";
          else if(agent.includes("Safari")&&!agent.includes("Chrome")) b="Safari";
          else if(agent.includes("Edge")) b="Edge";
          browsers[b]=(browsers[b]||0)+1;

          let deviceType="Desktop";
          if(/Mobile|Android|iPhone/i.test(agent)) deviceType="Mobile";
          else if(/Tablet|iPad/i.test(agent)) deviceType="Tablet";
          devices[deviceType]=(devices[deviceType]||0)+1;
        });
        visitsEl.textContent=visits; uniqueVisitorsEl.textContent=unique.size; pageviewsEl.textContent=pageviews;
        renderList(topPagesEl,pages); renderList(topReferrersEl,refs); renderList(topBrowsersEl,browsers); renderList(topDevicesEl,devices);

        const labels=Object.keys(daily),values=Object.values(daily);
        if(chart) chart.destroy(); const ctx=document.getElementById("trafficChart").getContext("2d");
        chart=new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"Visits",data:values,borderColor:"#6366f1",backgroundColor:"rgba(99,102,241,0.2)",fill:true,tension:0.3}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

        // Active Visitors
        setInterval(() => {
          const now = Date.now();
          const active = Object.values(filteredData).filter(e => now - e.timestamp < 300000);
          activeVisitorsEl.textContent = active.length;
        }, 5000);
      },err=>showError("Firebase error: "+err.message));
    }

    document.getElementById("loadBtn").onclick=()=>loadAnalytics(siteIdInput.value.trim(), parseInt(document.getElementById("timeRange").value));
    openModalBtn.onclick=()=>{ if(cachedData){renderTable(cachedData); eventsModal.style.display="block";} else showError("Load analytics first!");};
    closeModal.onclick=()=>eventsModal.style.display="none";
    window.onclick=e=>{ if(e.target===eventsModal) eventsModal.style.display="none"; if(e.target===welcomeModal) welcomeModal.style.display="none";};

    function clearAnalytics(){ if(currentRef) currentRef.remove(); }

    function openWelcome(){ welcomeModal.style.display="block"; }
    closeWelcome.onclick=()=>welcomeModal.style.display="none";
    copyBtn.onclick=()=>{ navigator.clipboard.writeText(scriptCode.textContent).then(()=>{copyBtn.textContent="âœ… Copied!"; setTimeout(()=>copyBtn.textContent="ðŸ“‹ Copy",1500);});};

    // Export CSV
    document.getElementById("exportBtn").onclick = () => {
      if(!cachedData) return showError("No data loaded!");
      const rows=[["URL","Referrer","User Agent","Timestamp"]]; Object.values(cachedData).forEach(e=>rows.push([e.url,e.referrer,e.userAgent,new Date(e.timestamp).toLocaleString()])); const csv=rows.map(r=>r.join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="analytics.csv"; a.click();
    };

    // On load: confetti then welcome modal
    window.onload=()=>{ confetti({ particleCount:100, spread:60, origin:{ y:0.6 } }); openWelcome(); };

    // Persistent Site ID from URL
    const params=new URLSearchParams(window.location.search);
    const siteFromUrl=params.get("site"); if(siteFromUrl){ siteIdInput.value=siteFromUrl; loadAnalytics(siteFromUrl);}
  </script>

</body>
</html>
